# SAI Dashboard - Local server configuration with SSE support
# This file is deployed by install-production.sh to /etc/nginx/sites-available/sai-dashboard

server {
    listen 80;
    listen [::]:80;
    server_name localhost 127.0.0.1 sai.altermundi.net _;
    
    # Dashboard - Exact redirect for trailing slash
    location = /dashboard {
        return 301 $scheme://$host/dashboard/;
    }
    
    # Dashboard static files
    location /dashboard/ {
        alias $WEB_ROOT/sai-dashboard/;
        try_files $uri $uri/ /dashboard/index.html;
        
        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # SSE Events endpoint - Force HTTP/1.1 for better browser compatibility
    location /dashboard/api/events {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSE-specific settings - critical for EventSource
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 24h;
        proxy_send_timeout 24h;
        chunked_transfer_encoding off;
        
        # Critical nginx SSE headers (research findings)
        proxy_set_header X-Accel-Buffering no;
        add_header X-Accel-Buffering no;
        
        # Force no compression for SSE (critical for streaming)
        gzip off;
        
        # SSE headers
        add_header Cache-Control "no-cache";
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Credentials "true";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Authorization, Cache-Control";
    }
    
    # Internal image serving via X-Accel-Redirect (not directly accessible)
    # Express sets X-Accel-Redirect header after auth + path resolution,
    # then nginx serves the file directly from disk (zero-copy sendfile).
    # Adjust alias path to match your local IMAGE_BASE_PATH.
    location /internal-images/ {
        internal;
        alias /mnt/raid1/n8n-backup/images/;

        sendfile on;
        tcp_nopush on;
        etag on;

        add_header X-Content-Type-Options nosniff always;
    }

    # Regular API proxy (non-SSE endpoints)
    location /dashboard/api/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering on;
    }
    
    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
}